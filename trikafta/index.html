<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trikafta — Mecanisme d'action | Labo Kodra</title>
  <meta name="description" content="Visualisation interactive du mecanisme d'action de Trikafta (elexacaftor/tezacaftor/ivacaftor) pour la fibrose kystique." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e1a;
      --bg2: #111827;
      --bg3: #1a2035;
      --text: #f0f4ff;
      --text2: #94a3b8;
      --muted: #64748b;
      --elx: #f472b6;
      --tez: #60a5fa;
      --iva: #34d399;
      --cftr: #a78bfa;
      --cl: #38bdf8;
      --membrane: #fbbf24;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; min-height: 100vh; }

    .topbar { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 16px 24px; }
    .topbar-inner { max-width: 1100px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .topbar-left { display: flex; align-items: center; gap: 10px; }
    .topbar-left img { height: 22px; opacity: 0.7; }
    .topbar-divider { width: 1px; height: 18px; background: rgba(255,255,255,0.1); }
    .topbar-badge { font-family: monospace; font-size: 12px; color: #6b7280; letter-spacing: 0.05em; }
    .back-link { font-family: monospace; font-size: 12px; color: #6b7280; text-decoration: none; transition: color 0.2s; display: flex; align-items: center; gap: 6px; }
    .back-link:hover { color: #F97316; }
    .back-link svg { width: 14px; height: 14px; }

    .page { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem; }
    .header { text-align: center; margin-bottom: 2.5rem; }
    .header h1 { font-size: 2.2rem; font-weight: 800; background: linear-gradient(135deg, var(--elx), var(--tez), var(--iva)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
    .header .sub { font-size: 1rem; color: var(--text2); font-weight: 300; }

    .step-nav { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
    .step-btn { padding: 0.65rem 1.4rem; border: 2px solid var(--muted); border-radius: 50px; background: transparent; color: var(--text2); font-family: 'Inter', sans-serif; font-size: 0.88rem; font-weight: 500; cursor: pointer; transition: all 0.3s; }
    .step-btn:hover { border-color: var(--text2); color: var(--text); }
    .step-btn.active { color: #fff; border-color: transparent; }
    .step-btn[data-s="0"].active { background: linear-gradient(135deg,#ef4444,#dc2626); }
    .step-btn[data-s="1"].active { background: linear-gradient(135deg,var(--elx),#ec4899); }
    .step-btn[data-s="2"].active { background: linear-gradient(135deg,var(--tez),#3b82f6); }
    .step-btn[data-s="3"].active { background: linear-gradient(135deg,var(--iva),#10b981); }
    .step-btn[data-s="4"].active { background: linear-gradient(135deg,var(--elx),var(--tez),var(--iva)); }

    .main { display: grid; grid-template-columns: 1fr 360px; gap: 1.5rem; align-items: start; }
    @media (max-width: 960px) { .main { grid-template-columns: 1fr; } }

    .viz { background: var(--bg2); border-radius: 16px; border: 1px solid rgba(255,255,255,0.06); overflow: hidden; }
    .viz svg { width: 100%; height: auto; display: block; }

    .panel { background: var(--bg3); border-radius: 16px; border: 1px solid rgba(255,255,255,0.06); padding: 1.75rem; position: sticky; top: 1.5rem; }
    .panel h2 { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.75rem; }
    .panel .desc { color: var(--text2); font-size: 0.92rem; line-height: 1.7; margin-bottom: 1.2rem; }
    .badge-row { margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .mol-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.7rem; border-radius: 20px; font-size: 0.78rem; font-weight: 600; }
    .mol-badge.elx { background: rgba(244,114,182,0.15); color: var(--elx); border: 1px solid rgba(244,114,182,0.3); }
    .mol-badge.tez { background: rgba(96,165,250,0.15); color: var(--tez); border: 1px solid rgba(96,165,250,0.3); }
    .mol-badge.iva { background: rgba(52,211,153,0.15); color: var(--iva); border: 1px solid rgba(52,211,153,0.3); }
    .kp { display: flex; align-items: flex-start; gap: 0.7rem; padding: 0.65rem 0; border-top: 1px solid rgba(255,255,255,0.05); }
    .kp .ic { font-size: 0.9rem; flex-shrink: 0; margin-top: 2px; }
    .kp .tx { font-size: 0.88rem; color: var(--text2); line-height: 1.5; }
    .kp .tx strong { color: var(--text); }

    .legend { display: flex; flex-wrap: wrap; gap: 1.2rem; justify-content: center; margin-top: 1.5rem; padding: 1rem; background: var(--bg3); border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); }
    .legend-item { display: flex; align-items: center; gap: 0.45rem; font-size: 0.8rem; color: var(--text2); }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    .footer-note { text-align: center; margin-top: 2rem; color: var(--muted); font-size: 0.78rem; }

    @keyframes bob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    @keyframes bob2 { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    @keyframes ionFlow { 0%{transform:translateY(0);opacity:0} 15%{opacity:1} 85%{opacity:1} 100%{transform:translateY(60px);opacity:0} }
    @keyframes ionFlowUp { 0%{transform:translateY(0);opacity:0} 15%{opacity:1} 85%{opacity:1} 100%{transform:translateY(-60px);opacity:0} }
    @keyframes pulseSoft { 0%,100%{opacity:0.4} 50%{opacity:0.9} }
    @keyframes bindSnap { 0%{transform:scale(0.5);opacity:0} 60%{transform:scale(1.15)} 100%{transform:scale(1);opacity:1} }
    .bob { animation: bob 3s ease-in-out infinite; }
    .bob2 { animation: bob2 3s ease-in-out 1.2s infinite; }
    .ion-flow { animation: ionFlow 2s ease-in-out infinite; }
    .ion-flow-d1 { animation: ionFlow 2s ease-in-out 0.5s infinite; }
    .ion-flow-d2 { animation: ionFlow 2s ease-in-out 1s infinite; }
    .ion-flow-up { animation: ionFlowUp 2.5s ease-in-out infinite; }
    .pulse { animation: pulseSoft 2s ease-in-out infinite; }

    @media (max-width: 640px) {
      .page { padding: 1rem; }
      .header h1 { font-size: 1.5rem; }
      .step-btn { padding: 0.4rem 0.9rem; font-size: 0.78rem; }
      .panel { padding: 1.2rem; }
    }
  </style>
</head>
<body>

<nav class="topbar">
  <div class="topbar-inner">
    <div class="topbar-left">
      <img src="https://kodra.ca/logo.png" alt="Kodra" />
      <div class="topbar-divider"></div>
      <span class="topbar-badge">labo / trikafta</span>
    </div>
    <a href="/" class="back-link">
      <svg fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/></svg>
      Retour au labo
    </a>
  </div>
</nav>

<div class="page">
  <header class="header">
    <h1>Trikafta : M&eacute;canisme d'action</h1>
    <p class="sub">Visualisation interactive de la triple th&eacute;rapie contre la fibrose kystique</p>
  </header>

  <nav class="step-nav" id="nav"></nav>

  <div class="main">
    <div class="viz">
      <svg id="svg" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- Membrane bilayer gradient -->
          <linearGradient id="gMemTop" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#fde68a" stop-opacity="0.9"/>
            <stop offset="100%" stop-color="#f59e0b"/>
          </linearGradient>
          <linearGradient id="gMemBot" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#f59e0b"/>
            <stop offset="100%" stop-color="#d97706" stop-opacity="0.9"/>
          </linearGradient>
          <linearGradient id="gCyto" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#1a1640" stop-opacity="0.7"/>
            <stop offset="100%" stop-color="#0c0f20" stop-opacity="0.95"/>
          </linearGradient>
          <linearGradient id="gExtra" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#0e1225"/>
            <stop offset="100%" stop-color="#151b33" stop-opacity="0.6"/>
          </linearGradient>
          <radialGradient id="glowP" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#a78bfa" stop-opacity="0.5"/>
            <stop offset="100%" stop-color="#a78bfa" stop-opacity="0"/>
          </radialGradient>
          <radialGradient id="glowE" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#f472b6" stop-opacity="0.4"/>
            <stop offset="100%" stop-color="#f472b6" stop-opacity="0"/>
          </radialGradient>
          <radialGradient id="glowI" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#34d399" stop-opacity="0.4"/>
            <stop offset="100%" stop-color="#34d399" stop-opacity="0"/>
          </radialGradient>
          <filter id="blur3"><feGaussianBlur stdDeviation="3"/></filter>
          <filter id="blur6"><feGaussianBlur stdDeviation="6"/></filter>
          <!-- Arrow markers -->
          <marker id="arrRed" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M0,0 L10,5 L0,10 Z" fill="#ef4444"/>
          </marker>
          <marker id="arrBlue" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M0,0 L10,5 L0,10 Z" fill="#60a5fa"/>
          </marker>
          <marker id="arrCyan" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M0,0 L10,5 L0,10 Z" fill="#38bdf8"/>
          </marker>
        </defs>
        <g id="scene"></g>
      </svg>
    </div>
    <aside class="panel" id="panel"></aside>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#a78bfa"></div> Prot&eacute;ine CFTR</div>
    <div class="legend-item"><div class="legend-dot" style="background:#f472b6"></div> Elexacaftor</div>
    <div class="legend-item"><div class="legend-dot" style="background:#60a5fa"></div> Tezacaftor</div>
    <div class="legend-item"><div class="legend-dot" style="background:#34d399"></div> Ivacaftor</div>
    <div class="legend-item"><div class="legend-dot" style="background:#38bdf8"></div> Ions Cl&minus;</div>
    <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div> Membrane</div>
  </div>

  <p class="footer-note">Visualisation &eacute;ducative &mdash; ne constitue pas un avis m&eacute;dical.</p>
</div>

<script>
const S=[
  {id:'problem',label:'Le probl\u00e8me',title:'Fibrose kystique : la prot\u00e9ine CFTR d\u00e9fectueuse',
   desc:'La mutation F508del emp\u00eache la prot\u00e9ine CFTR de se replier correctement. Elle reste pi\u00e9g\u00e9e dans le r\u00e9ticulum endoplasmique et n\u2019atteint jamais la membrane cellulaire. Sans canal CFTR fonctionnel, les ions chlorure ne peuvent pas traverser la membrane, l\u2019eau ne suit pas, et le mucus qui tapisse les voies respiratoires devient \u00e9pais et collant.',
   badges:[],pts:[
     {i:'\ud83e\uddec',t:'<strong>Mutation F508del</strong> \u2014 pr\u00e9sente chez ~90\u00a0% des patients FK'},
     {i:'\u274c',t:'<strong>CFTR mal repli\u00e9e</strong> \u2014 d\u00e9grad\u00e9e avant d\u2019atteindre la surface'},
     {i:'\ud83e\udec1',t:'<strong>Mucus \u00e9pais</strong> \u2014 infections et obstruction des bronches'}]},
  {id:'elexacaftor',label:'Elexacaftor',title:'\u00c9tape 1 : Elexacaftor (Correcteur)',
   desc:'L\u2019elexacaftor est un correcteur de type I. Il se fixe \u00e0 l\u2019interface TMD1-TMD2 de la prot\u00e9ine CFTR mut\u00e9e et stabilise son repliement tridimensionnel. Cela emp\u00eache le contr\u00f4le qualit\u00e9 cellulaire de d\u00e9grader la prot\u00e9ine pr\u00e9matur\u00e9ment.',
   badges:['elx'],pts:[
     {i:'\ud83d\udd27',t:'<strong>Correcteur de type I</strong> \u2014 se fixe \u00e0 l\u2019interface TMD1-TMD2'},
     {i:'\ud83d\udcd0',t:'<strong>Stabilise le repliement 3D</strong> \u2014 la prot\u00e9ine adopte la bonne forme'},
     {i:'\ud83d\udee1\ufe0f',t:'<strong>\u00c9vite la d\u00e9gradation</strong> \u2014 CFTR survit au contr\u00f4le qualit\u00e9'}]},
  {id:'tezacaftor',label:'Tezacaftor',title:'\u00c9tape 2 : Tezacaftor (Correcteur)',
   desc:'Le tezacaftor est un correcteur de type II. Il se fixe \u00e0 un site diff\u00e9rent (TMD1) de celui de l\u2019elexacaftor. Ensemble, les deux correcteurs ont un effet synergique et am\u00e9liorent consid\u00e9rablement le transport de CFTR du r\u00e9ticulum endoplasmique vers l\u2019appareil de Golgi, puis jusqu\u2019\u00e0 la membrane cellulaire.',
   badges:['elx','tez'],pts:[
     {i:'\ud83d\udd29',t:'<strong>Correcteur de type II</strong> \u2014 se fixe au domaine TMD1'},
     {i:'\ud83e\udd1d',t:'<strong>Effet synergique</strong> \u2014 compl\u00e9mentaire \u00e0 l\u2019elexacaftor'},
     {i:'\ud83d\ude80',t:'<strong>Transport r\u00e9tabli</strong> \u2014 CFTR atteint la membrane cellulaire'}]},
  {id:'ivacaftor',label:'Ivacaftor',title:'\u00c9tape 3 : Ivacaftor (Potentiateur)',
   desc:'L\u2019ivacaftor est un potentiateur. Contrairement aux correcteurs, il n\u2019agit pas sur le repliement mais sur la fonction : une fois la prot\u00e9ine CFTR ins\u00e9r\u00e9e dans la membrane, l\u2019ivacaftor augmente la probabilit\u00e9 d\u2019ouverture du canal. Les ions chlorure traversent, l\u2019eau suit par osmose, et le mucus se fluidifie.',
   badges:['iva'],pts:[
     {i:'\ud83d\udd13',t:'<strong>Potentiateur</strong> \u2014 augmente le temps d\u2019ouverture du canal CFTR'},
     {i:'\u26a1',t:'<strong>Flux de Cl\u207b restaur\u00e9</strong> \u2014 les ions traversent la membrane'},
     {i:'\ud83d\udca7',t:'<strong>Hydratation du mucus</strong> \u2014 l\u2019eau suit par osmose'}]},
  {id:'result',label:'R\u00e9sultat',title:'Trikafta : le r\u00e9sultat combin\u00e9',
   desc:'Les trois mol\u00e9cules de Trikafta agissent \u00e0 diff\u00e9rentes \u00e9tapes du cycle de vie de CFTR : les correcteurs (ELX + TEZ) r\u00e9parent et acheminent la prot\u00e9ine, puis le potentiateur (IVA) l\u2019active. Le r\u00e9sultat : plus de canaux fonctionnels, un mucus fluide, et une am\u00e9lioration clinique majeure.',
   badges:['elx','tez','iva'],pts:[
     {i:'\u2705',t:'<strong>+14\u00a0% de VEMS</strong> \u2014 am\u00e9lioration de la fonction pulmonaire'},
     {i:'\ud83d\udcc9',t:'<strong>\u221263\u00a0% d\u2019exacerbations</strong> \u2014 moins de crises respiratoires'},
     {i:'\ud83c\udfaf',t:'<strong>~90\u00a0% des patients FK</strong> \u2014 \u00e9ligibles (au moins 1 F508del)'}]}
];

let cur=0;
const $=s=>document.querySelector(s);
const nav=$('#nav'), scene=$('#scene'), panel=$('#panel');

function init(){
  nav.innerHTML=S.map((s,i)=>`<button class="step-btn" data-s="${i}">${s.label}</button>`).join('');
  nav.addEventListener('click',e=>{const b=e.target.closest('.step-btn');if(b)go(+b.dataset.s);});
  go(0);
}

function go(i){
  cur=i;
  nav.querySelectorAll('.step-btn').forEach(b=>b.classList.toggle('active',+b.dataset.s===i));
  scene.innerHTML=[scProblem,scElx,scTez,scIva,scResult][i]();
  renderPanel(i);
}

function renderPanel(i){
  const d=S[i], colors=['#ef4444','#f472b6','#60a5fa','#34d399','#a78bfa'];
  const bm={elx:['Elexacaftor','elx'],tez:['Tezacaftor','tez'],iva:['Ivacaftor','iva']};
  let bh=d.badges.length?'<div class="badge-row">'+d.badges.map(b=>`<span class="mol-badge ${bm[b][1]}">${bm[b][0]}</span>`).join('')+'</div>':'';
  panel.innerHTML=`<h2 style="color:${colors[i]}">${d.title}</h2>${bh}<p class="desc">${d.desc}</p>${d.pts.map(p=>`<div class="kp"><span class="ic">${p.i}</span><span class="tx">${p.t}</span></div>`).join('')}`;
}

/* ── SVG building blocks ── */

/* Bilayer membrane with phospholipid heads */
function membrane(gapX, gapW){
  let s = '';
  // Top leaflet (extracellular side)
  s += `<rect x="0" y="250" width="800" height="30" fill="url(#gMemTop)" rx="2"/>`;
  // Hydrophobic core
  s += `<rect x="0" y="280" width="800" height="30" fill="#b45309" opacity="0.6"/>`;
  // Bottom leaflet (cytoplasmic side)
  s += `<rect x="0" y="310" width="800" height="30" fill="url(#gMemBot)" rx="2"/>`;
  // Phospholipid head decoration
  for(let x=20; x<800; x+=20){
    if(gapX && x > gapX-5 && x < gapX+gapW+5) continue;
    s += `<circle cx="${x}" cy="253" r="6" fill="#fde68a" opacity="0.35"/>`;
    s += `<circle cx="${x}" cy="337" r="6" fill="#fde68a" opacity="0.35"/>`;
  }
  s += `<text x="680" y="298" text-anchor="middle" fill="#78350f" font-size="11" font-family="Inter" font-weight="600" opacity="0.8">MEMBRANE</text>`;
  return s;
}

/* Zone labels */
function zones(extraLabel, cytoLabel){
  return `
    <rect x="0" y="0" width="800" height="250" fill="url(#gExtra)"/>
    <rect x="0" y="340" width="800" height="260" fill="url(#gCyto)"/>
    <g transform="translate(16,22)">
      <rect x="0" y="0" width="200" height="26" rx="13" fill="rgba(255,255,255,0.04)" stroke="rgba(255,255,255,0.08)" stroke-width="1"/>
      <text x="100" y="17" text-anchor="middle" fill="#64748b" font-size="11" font-family="Inter" font-weight="500">${extraLabel || 'ESPACE EXTRACELLULAIRE'}</text>
    </g>
    <g transform="translate(16,570)">
      <rect x="0" y="0" width="140" height="24" rx="12" fill="rgba(255,255,255,0.04)" stroke="rgba(255,255,255,0.08)" stroke-width="1"/>
      <text x="70" y="16" text-anchor="middle" fill="#64748b" font-size="11" font-family="Inter" font-weight="500">${cytoLabel || 'CYTOPLASME'}</text>
    </g>`;
}

/* Mucus layer */
function mucus(thickness, color, opacity, label){
  const h = thickness;
  const y = 250 - h;
  return `
    <rect x="0" y="${y}" width="800" height="${h}" fill="${color}" opacity="${opacity}" rx="4"/>
    <text x="400" y="${y + h/2 + 4}" text-anchor="middle" fill="${color}" font-size="13" font-family="Inter" font-weight="600" opacity="0.9">${label}</text>`;
}

/* CFTR channel in membrane — proper transmembrane shape */
function cftrChannel(x, state, highlight){
  // state: 'empty','closed','open'
  const cx = x;
  if(state === 'empty'){
    return `<g transform="translate(${cx},248)">
      <rect x="0" y="0" width="70" height="94" rx="8" fill="rgba(30,27,75,0.5)" stroke="#4b5563" stroke-width="2" stroke-dasharray="6,4"/>
      <text x="35" y="42" text-anchor="middle" fill="#6b7280" font-size="12" font-family="Inter" font-weight="500">Canal</text>
      <text x="35" y="58" text-anchor="middle" fill="#6b7280" font-size="12" font-family="Inter" font-weight="500">CFTR</text>
      <text x="35" y="76" text-anchor="middle" fill="#ef4444" font-size="11" font-family="Inter" font-weight="600">ABSENT</text>
    </g>`;
  }
  const poreW = state === 'open' ? 22 : 6;
  const poreColor = state === 'open' ? '#0f172a' : '#1e1b4b';
  const borderColor = state === 'open' ? '#34d399' : '#a78bfa';
  const glowOpacity = state === 'open' ? '0.25' : '0.1';
  return `<g transform="translate(${cx},245)">
    ${highlight ? `<circle cx="35" cy="50" r="60" fill="url(#glowP)" opacity="0.5"/>` : ''}
    <!-- Channel body -->
    <rect x="0" y="0" width="70" height="100" rx="10" fill="#2d2060" stroke="${borderColor}" stroke-width="2.5"/>
    <!-- Inner pore -->
    <rect x="${35-poreW/2}" y="6" width="${poreW}" height="88" rx="${poreW/3}" fill="${poreColor}" stroke="${borderColor}" stroke-width="1.5" opacity="0.9"/>
    <!-- Alpha helices decoration -->
    <rect x="8" y="12" width="6" height="76" rx="3" fill="#4c3a8a" opacity="0.5"/>
    <rect x="56" y="12" width="6" height="76" rx="3" fill="#4c3a8a" opacity="0.5"/>
    <!-- Label -->
    <text x="35" y="-10" text-anchor="middle" fill="#c4b5fd" font-size="13" font-family="Inter" font-weight="700">CFTR</text>
    ${state === 'open' ? `<text x="35" y="-25" text-anchor="middle" fill="#34d399" font-size="11" font-family="Inter" font-weight="600">CANAL OUVERT</text>` : ''}
  </g>`;
}

/* Drug molecule — distinctive shapes */
function drugMol(x, y, type, size, animated){
  const s = size || 1;
  const r = 16 * s;
  const cls = animated ? 'bob' : '';
  if(type === 'elx'){
    const inner = `<circle cx="0" cy="0" r="${r+10}" fill="url(#glowE)"/><polygon points="${pentPoints(0,0,r)}" fill="#f472b6" stroke="#ec4899" stroke-width="2"/><text x="0" y="4" text-anchor="middle" fill="#fff" font-size="${10*s}" font-weight="700" font-family="Inter">ELX</text>`;
    return cls ? `<g transform="translate(${x},${y})"><g class="${cls}">${inner}</g></g>` : `<g transform="translate(${x},${y})">${inner}</g>`;
  }
  if(type === 'tez'){
    const inner = `<circle cx="0" cy="0" r="${r+8}" fill="rgba(96,165,250,0.15)"/><polygon points="0,${-r} ${r},0 0,${r} ${-r},0" fill="#60a5fa" stroke="#3b82f6" stroke-width="2"/><text x="0" y="4" text-anchor="middle" fill="#fff" font-size="${10*s}" font-weight="700" font-family="Inter">TEZ</text>`;
    return cls ? `<g transform="translate(${x},${y})"><g class="${cls}">${inner}</g></g>` : `<g transform="translate(${x},${y})">${inner}</g>`;
  }
  if(type === 'iva'){
    const inner = `<circle cx="0" cy="0" r="${r+10}" fill="url(#glowI)"/><polygon points="${hexPoints(0,0,r)}" fill="#34d399" stroke="#10b981" stroke-width="2"/><text x="0" y="4" text-anchor="middle" fill="#fff" font-size="${10*s}" font-weight="700" font-family="Inter">IVA</text>`;
    return cls ? `<g transform="translate(${x},${y})"><g class="${cls}">${inner}</g></g>` : `<g transform="translate(${x},${y})">${inner}</g>`;
  }
  return '';
}

function pentPoints(cx,cy,r){
  return Array.from({length:5},(_,i)=>{const a=Math.PI*2*i/5-Math.PI/2;return `${cx+r*Math.cos(a)},${cy+r*Math.sin(a)}`;}).join(' ');
}
function hexPoints(cx,cy,r){
  return Array.from({length:6},(_,i)=>{const a=Math.PI*2*i/6-Math.PI/6;return `${cx+r*Math.cos(a)},${cy+r*Math.sin(a)}`;}).join(' ');
}

/* Chloride ion */
function ion(x, y, opacity, cls){
  const inner = `<circle cx="0" cy="0" r="10" fill="#38bdf8" opacity="0.85"/><text x="0" y="4" text-anchor="middle" fill="#fff" font-size="9" font-weight="700" font-family="Inter">Cl\u207b</text>`;
  if(cls) return `<g transform="translate(${x},${y})" opacity="${opacity||1}"><g class="${cls}">${inner}</g></g>`;
  return `<g transform="translate(${x},${y})" opacity="${opacity||1}">${inner}</g>`;
}

/* Water molecule */
function water(x,y,o){
  return `<g transform="translate(${x},${y})" opacity="${o||0.6}"><circle cx="0" cy="0" r="6" fill="#7dd3fc" opacity="0.7"/><circle cx="8" cy="-5" r="3.5" fill="#bae6fd" opacity="0.6"/><circle cx="8" cy="5" r="3.5" fill="#bae6fd" opacity="0.6"/></g>`;
}

/* Misfolded protein blob */
function misfoldedCFTR(x, y){
  return `<g transform="translate(${x},${y})">
    <circle cx="0" cy="0" r="55" fill="url(#glowP)" opacity="0.3"/>
    <!-- Irregular misfolded shape -->
    <path d="M-30,-20 Q-20,-40 0,-30 Q20,-45 30,-25 Q45,-10 35,5 Q45,25 30,30 Q15,45 0,35 Q-20,45 -30,30 Q-45,15 -35,0 Q-45,-10 -30,-20Z"
          fill="#52506b" stroke="#6b7280" stroke-width="2.5" stroke-dasharray="0"/>
    <!-- Tangled lines to show misfolding -->
    <path d="M-15,-10 Q5,-25 10,-5 Q20,5 5,15 Q-10,10 -15,-10" fill="none" stroke="#9ca3af" stroke-width="1.5" opacity="0.5"/>
    <text x="0" y="2" text-anchor="middle" fill="#fff" font-size="13" font-weight="700" font-family="Inter">CFTR</text>
    <text x="0" y="18" text-anchor="middle" fill="#fca5a5" font-size="10" font-weight="600" font-family="Inter">Mal repli\u00e9e</text>
    <!-- Big red X -->
    <g transform="translate(35,-30)">
      <circle cx="0" cy="0" r="14" fill="rgba(239,68,68,0.2)" stroke="#ef4444" stroke-width="2"/>
      <line x1="-6" y1="-6" x2="6" y2="6" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/>
      <line x1="6" y1="-6" x2="-6" y2="6" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/>
    </g>
  </g>`;
}

/* Correcting protein */
function correctingCFTR(x, y, drugsBound){
  return `<g transform="translate(${x},${y})">
    <circle cx="0" cy="0" r="55" fill="url(#glowP)" opacity="0.35"/>
    <!-- More regular shape (correcting) -->
    <path d="M-28,-22 Q-15,-38 5,-30 Q25,-38 32,-22 Q42,-5 32,10 Q40,28 25,32 Q10,40 -5,32 Q-22,38 -30,22 Q-42,8 -35,-5 Q-40,-15 -28,-22Z"
          fill="#6d5eac" stroke="#a78bfa" stroke-width="2.5"/>
    <text x="0" y="2" text-anchor="middle" fill="#fff" font-size="13" font-weight="700" font-family="Inter">CFTR</text>
    <text x="0" y="18" text-anchor="middle" fill="#c4b5fd" font-size="9" font-weight="500" font-family="Inter">En correction</text>
    ${drugsBound.includes('elx') ? drugMol(42, -22, 'elx', 0.7, true) : ''}
    ${drugsBound.includes('tez') ? drugMol(-42, 18, 'tez', 0.7, true) : ''}
  </g>`;
}

/* Corrected protein ready to go */
function correctedCFTR(x, y){
  return `<g transform="translate(${x},${y})"><g class="bob">
    <circle cx="0" cy="0" r="50" fill="url(#glowP)" opacity="0.3"/>
    <!-- Clean symmetric shape -->
    <path d="M-25,-20 Q-10,-35 10,-28 Q28,-35 30,-18 Q38,-2 30,12 Q35,28 22,30 Q8,38 -8,30 Q-25,35 -28,20 Q-38,5 -30,-8 Q-35,-15 -25,-20Z"
          fill="#7c6bb5" stroke="#a78bfa" stroke-width="2.5"/>
    <text x="0" y="0" text-anchor="middle" fill="#fff" font-size="12" font-weight="700" font-family="Inter">CFTR</text>
    <text x="0" y="14" text-anchor="middle" fill="#c4b5fd" font-size="9" font-weight="500" font-family="Inter">Corrig\u00e9e</text>
    ${drugMol(38, -18, 'elx', 0.55, false)}
    ${drugMol(-36, 14, 'tez', 0.55, false)}
  </g></g>`;
}

/* Annotation box */
function note(x, y, w, lines, bgColor, borderColor){
  const h = 18 + lines.length * 18;
  let s = `<g transform="translate(${x},${y})"><rect x="0" y="0" width="${w}" height="${h}" rx="10" fill="${bgColor}" stroke="${borderColor}" stroke-width="1"/>`;
  lines.forEach((l,i)=>{
    s += `<text x="${w/2}" y="${18+i*18}" text-anchor="middle" fill="${l.c||'#9ca3af'}" font-size="${l.s||11}" font-family="Inter" ${l.b?'font-weight="600"':''}>${l.t}</text>`;
  });
  return s+'</g>';
}

/* Binding line with label */
function bindLine(x1,y1,x2,y2,color,label){
  const mx=(x1+x2)/2, my=(y1+y2)/2;
  return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${color}" stroke-width="2" stroke-dasharray="5,3" opacity="0.7"/>
  ${label?`<text x="${mx}" y="${my-6}" text-anchor="middle" fill="${color}" font-size="9" font-family="Inter" font-weight="500">${label}</text>`:''}`;
}

/* ── SCENES ── */

function scProblem(){
  return zones('VOIES RESPIRATOIRES','INT\u00c9RIEUR DE LA CELLULE')
    + mucus(90, '#ef4444', 0.25, 'MUCUS \u00c9PAIS ET COLLANT')
    + membrane(365, 70)
    /* Empty channel */
    + cftrChannel(365, 'empty', false)
    /* Misfolded protein stuck in ER */
    + `<g transform="translate(300,390)">
        <rect x="0" y="0" width="200" height="150" rx="20" fill="rgba(107,114,128,0.08)" stroke="rgba(107,114,128,0.2)" stroke-width="1.5" stroke-dasharray="0"/>
        <text x="100" y="22" text-anchor="middle" fill="#9ca3af" font-size="12" font-family="Inter" font-weight="600">R\u00e9ticulum endoplasmique</text>
      </g>`
    + misfoldedCFTR(400, 480)
    /* Degradation arrow */
    + `<line x1="460" y1="490" x2="560" y2="510" stroke="#ef4444" stroke-width="2.5" marker-end="url(#arrRed)"/>
       <text x="540" y="540" fill="#fca5a5" font-size="12" font-family="Inter" font-weight="600">D\u00e9gradation</text>
       <text x="540" y="556" fill="#9ca3af" font-size="10" font-family="Inter">(prot\u00e9asome)</text>`
    /* Blocked ions above */
    + ion(350, 140, 0.5, 'bob') + ion(400, 110, 0.4, 'bob2') + ion(450, 145, 0.5, 'bob')
    + ion(330, 180, 0.3) + ion(470, 175, 0.35)
    + `<text x="400" y="210" text-anchor="middle" fill="#7dd3fc" font-size="12" font-family="Inter" font-weight="500" opacity="0.7">Ions Cl\u207b bloqu\u00e9s \u2014 pas de canal</text>`
    /* Consequence box */
    + note(30, 420, 210, [
        {t:'Cons\u00e9quences', c:'#fca5a5', s:12, b:true},
        {t:'Infections pulmonaires r\u00e9currentes', c:'#9ca3af', s:10},
        {t:'Inflammation chronique', c:'#9ca3af', s:10},
        {t:'Obstruction des bronches', c:'#9ca3af', s:10},
      ], 'rgba(239,68,68,0.08)', 'rgba(239,68,68,0.25)');
}

function scElx(){
  return zones('VOIES RESPIRATOIRES','INT\u00c9RIEUR DE LA CELLULE')
    + mucus(80, '#ef4444', 0.2, 'Mucus encore \u00e9pais')
    + membrane(365, 70)
    + cftrChannel(365, 'empty', false)
    /* ER with correcting protein */
    + `<g transform="translate(280,380)">
        <rect x="0" y="0" width="240" height="170" rx="20" fill="rgba(244,114,182,0.06)" stroke="rgba(244,114,182,0.2)" stroke-width="1.5"/>
        <text x="120" y="22" text-anchor="middle" fill="#f472b6" font-size="12" font-family="Inter" font-weight="600">R\u00e9ticulum endoplasmique \u2014 Correction</text>
      </g>`
    + correctingCFTR(400, 480, ['elx'])
    /* Free ELX molecule approaching */
    + drugMol(560, 430, 'elx', 1.1, true)
    + bindLine(520, 445, 445, 465, '#f472b6', 'Liaison')
    /* Info */
    + note(30, 400, 200, [
        {t:'Site de liaison', c:'#f472b6', s:12, b:true},
        {t:'Interface TMD1-TMD2', c:'#f472b6', s:11},
        {t:'Stabilise la conformation', c:'#9ca3af', s:10},
        {t:'3D de la prot\u00e9ine', c:'#9ca3af', s:10},
      ], 'rgba(244,114,182,0.06)', 'rgba(244,114,182,0.2)')
    /* Ions still stuck */
    + ion(370, 140, 0.4, 'bob') + ion(420, 120, 0.35, 'bob2') + ion(450, 150, 0.4);
}

function scTez(){
  return zones('VOIES RESPIRATOIRES','INT\u00c9RIEUR DE LA CELLULE')
    + mucus(75, '#ef4444', 0.18, 'Mucus encore \u00e9pais')
    + membrane(365, 70)
    /* Channel ghost appearing */
    + `<g transform="translate(365,245)">
        <rect x="0" y="0" width="70" height="100" rx="10" fill="#2d2060" stroke="#a78bfa" stroke-width="2" opacity="0.35"/>
        <text x="35" y="55" text-anchor="middle" fill="#a78bfa" font-size="11" font-family="Inter" font-weight="500" opacity="0.6">En route...</text>
      </g>`
    /* Transport vesicle with corrected protein */
    + `<g transform="translate(340, 370)">
        <ellipse cx="60" cy="50" rx="65" ry="45" fill="rgba(96,165,250,0.06)" stroke="#60a5fa" stroke-width="1.5" stroke-dasharray="6,4"/>
        <text x="60" y="15" text-anchor="middle" fill="#60a5fa" font-size="11" font-family="Inter" font-weight="500">V\u00e9sicule de transport</text>
      </g>`
    + correctedCFTR(400, 425)
    /* Arrow from vesicle to membrane */
    + `<line x1="400" y1="370" x2="400" y2="350" stroke="#60a5fa" stroke-width="2.5" marker-end="url(#arrBlue)"/>
       <text x="420" y="362" fill="#60a5fa" font-size="10" font-family="Inter" font-weight="500">\u2191 Vers la membrane</text>`
    /* Free TEZ */
    + drugMol(560, 450, 'tez', 1.1, true)
    + bindLine(525, 445, 438, 440, '#60a5fa', 'Liaison')
    /* Info box */
    + note(30, 400, 210, [
        {t:'Double correction', c:'#60a5fa', s:12, b:true},
        {t:'ELX \u2192 interface TMD1-TMD2', c:'#9ca3af', s:10},
        {t:'TEZ \u2192 domaine TMD1', c:'#9ca3af', s:10},
        {t:'', c:'transparent', s:4},
        {t:'= Effet synergique', c:'#60a5fa', s:11, b:true},
      ], 'rgba(96,165,250,0.06)', 'rgba(96,165,250,0.2)')
    /* Pathway */
    + note(570, 540, 200, [
        {t:'Trajet de CFTR', c:'#60a5fa', s:11, b:true},
        {t:'R\u00e9t. Endoplasmique \u2192 Golgi', c:'#9ca3af', s:10},
        {t:'\u2192 Membrane cellulaire', c:'#9ca3af', s:10},
      ], 'rgba(96,165,250,0.06)', 'rgba(96,165,250,0.15)')
    + ion(370, 140, 0.4, 'bob') + ion(420, 120, 0.35, 'bob2') + ion(450, 150, 0.4);
}

function scIva(){
  return zones('VOIES RESPIRATOIRES','INT\u00c9RIEUR DE LA CELLULE')
    + mucus(50, '#34d399', 0.12, 'Mucus en fluidification')
    + membrane(365, 70)
    /* CFTR channel OPEN with drugs bound */
    + cftrChannel(365, 'open', true)
    /* Drugs bound to channel */
    + drugMol(350, 270, 'elx', 0.6, false)
    + drugMol(350, 320, 'tez', 0.6, false)
    + drugMol(455, 295, 'iva', 0.8, true)
    + bindLine(443, 295, 438, 295, '#34d399', '')
    /* Chloride ions flowing THROUGH the channel */
    + `<g>${ion(400, 130, 0.9, 'ion-flow')}${ion(395, 130, 0.8, 'ion-flow-d1')}${ion(405, 130, 0.7, 'ion-flow-d2')}</g>`
    /* Ions already through below */
    + ion(390, 370, 0.7, 'bob') + ion(410, 400, 0.6, 'bob2')
    /* Flow direction arrows */
    + `<line x1="400" y1="100" x2="400" y2="240" stroke="#38bdf8" stroke-width="1.5" stroke-dasharray="5,4" opacity="0.4" marker-end="url(#arrCyan)"/>
       <line x1="400" y1="350" x2="400" y2="420" stroke="#38bdf8" stroke-width="1.5" stroke-dasharray="5,4" opacity="0.4" marker-end="url(#arrCyan)"/>`
    /* Water molecules */
    + water(430, 160, 0.5) + water(450, 185, 0.4) + water(425, 210, 0.45)
    + `<text x="480" y="195" fill="#7dd3fc" font-size="10" font-family="Inter" font-weight="500" opacity="0.7">H\u2082O suit Cl\u207b</text>`
    /* Info */
    + note(560, 400, 210, [
        {t:'Ivacaftor \u2014 Potentiateur', c:'#34d399', s:12, b:true},
        {t:'Augmente la probabilit\u00e9', c:'#9ca3af', s:10},
        {t:'d\u2019ouverture du canal', c:'#9ca3af', s:10},
        {t:'', c:'transparent', s:4},
        {t:'\u2192 Flux de Cl\u207b restaur\u00e9', c:'#34d399', s:11, b:true},
      ], 'rgba(52,211,153,0.06)', 'rgba(52,211,153,0.2)')
    + note(30, 420, 190, [
        {t:'M\u00e9canisme', c:'#34d399', s:11, b:true},
        {t:'Cl\u207b sort de la cellule', c:'#9ca3af', s:10},
        {t:'\u2192 H\u2082O suit par osmose', c:'#9ca3af', s:10},
        {t:'\u2192 Mucus se fluidifie', c:'#34d399', s:10},
      ], 'rgba(52,211,153,0.06)', 'rgba(52,211,153,0.15)');
}

function scResult(){
  return zones('VOIES RESPIRATOIRES \u2014 D\u00c9GAG\u00c9ES','INT\u00c9RIEUR DE LA CELLULE')
    + mucus(30, '#34d399', 0.06, 'Mucus fluide et hydrat\u00e9')
    + membrane(175, 70) /* gap for channel 1 */
    /* 3 working channels */
    + cftrChannel(175, 'open', false)
    + cftrChannel(365, 'open', false)
    + cftrChannel(555, 'open', false)
    /* Drug dots on each channel */
    + smallDrug(160, 272, 'elx') + smallDrug(160, 318, 'tez') + smallDrug(262, 295, 'iva')
    + smallDrug(350, 272, 'elx') + smallDrug(350, 318, 'tez') + smallDrug(452, 295, 'iva')
    + smallDrug(540, 272, 'elx') + smallDrug(540, 318, 'tez') + smallDrug(642, 295, 'iva')
    /* Flowing ions */
    + ion(210, 120, 0.8, 'ion-flow') + ion(400, 110, 0.9, 'ion-flow-d1') + ion(590, 125, 0.8, 'ion-flow-d2')
    + ion(205, 120, 0.6, 'ion-flow-d2') + ion(395, 120, 0.7, 'ion-flow-d1') + ion(585, 120, 0.65, 'ion-flow')
    + ion(210, 380, 0.6, 'bob') + ion(400, 390, 0.7, 'bob2') + ion(590, 375, 0.6, 'bob')
    /* Water */
    + water(240, 150, 0.4) + water(430, 145, 0.35) + water(620, 155, 0.4)
    /* Stats panel */
    + `<g transform="translate(100,430)">
        <rect x="0" y="0" width="600" height="120" rx="16" fill="rgba(52,211,153,0.05)" stroke="rgba(52,211,153,0.15)" stroke-width="1"/>
        <text x="300" y="25" text-anchor="middle" fill="#34d399" font-size="13" font-family="Inter" font-weight="600">R\u00e9sultats cliniques de Trikafta</text>
        <!-- Stat 1 -->
        <text x="110" y="60" text-anchor="middle" fill="#34d399" font-size="28" font-weight="800" font-family="Inter">+14%</text>
        <text x="110" y="80" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Inter">Fonction pulmonaire</text>
        <text x="110" y="95" text-anchor="middle" fill="#64748b" font-size="9" font-family="Inter">(VEMS / ppFEV1)</text>
        <!-- Divider -->
        <line x1="205" y1="40" x2="205" y2="105" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>
        <!-- Stat 2 -->
        <text x="305" y="60" text-anchor="middle" fill="#60a5fa" font-size="28" font-weight="800" font-family="Inter">-63%</text>
        <text x="305" y="80" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Inter">Exacerbations</text>
        <text x="305" y="95" text-anchor="middle" fill="#64748b" font-size="9" font-family="Inter">pulmonaires</text>
        <!-- Divider -->
        <line x1="400" y1="40" x2="400" y2="105" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>
        <!-- Stat 3 -->
        <text x="500" y="60" text-anchor="middle" fill="#f472b6" font-size="28" font-weight="800" font-family="Inter">~90%</text>
        <text x="500" y="80" text-anchor="middle" fill="#9ca3af" font-size="10" font-family="Inter">Patients FK</text>
        <text x="500" y="95" text-anchor="middle" fill="#64748b" font-size="9" font-family="Inter">\u00e9ligibles au traitement</text>
        <text x="300" y="115" text-anchor="middle" fill="#4b5563" font-size="9" font-family="Inter">Essais cliniques de phase 3 (2019)</text>
      </g>`
    /* Title */
    + `<text x="400" y="185" text-anchor="middle" fill="#34d399" font-size="15" font-family="Inter" font-weight="700">Triple th\u00e9rapie active</text>
       <text x="400" y="205" text-anchor="middle" fill="#94a3b8" font-size="11" font-family="Inter">ELX + TEZ corrigent \u2022 IVA potentialise \u2022 Mucus fluide</text>`;
}

function smallDrug(x, y, type){
  const colors = {elx:'#f472b6', tez:'#60a5fa', iva:'#34d399'};
  return `<circle cx="${x}" cy="${y}" r="7" fill="${colors[type]}" opacity="0.8"/>`;
}

init();
</script>
</body>
</html>
